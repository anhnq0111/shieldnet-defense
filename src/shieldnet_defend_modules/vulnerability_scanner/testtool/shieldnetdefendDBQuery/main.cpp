/*
 * ShieldnetDefend Vulnerability scanner
 * Copyright (C) 2015, ShieldnetDefend Inc.
 * Nov 1, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "argsParser.hpp"
#include "json.hpp"
#include "socketDBWrapper.hpp"
#include "shieldnetdefendDBQueryBuilder.hpp"
#include <iostream>
#include <unordered_map>

auto constexpr SHIELDNET_DEFEND_DB_SOCK {"/var/ossec/queue/db/wdb"};

const std::unordered_map<std::string, ShieldnetDefendDBQueryBuilder& (ShieldnetDefendDBQueryBuilder::*)()> FUNC_MAP {
    {"global", &ShieldnetDefendDBQueryBuilder::global}, {"selectAll", &ShieldnetDefendDBQueryBuilder::selectAll}};

const std::unordered_map<std::string, ShieldnetDefendDBQueryBuilder& (ShieldnetDefendDBQueryBuilder::*)(const std::string&)> FUNC_ARG_MAP {
    {"agent", &ShieldnetDefendDBQueryBuilder::agent},
    {"fromTable", &ShieldnetDefendDBQueryBuilder::fromTable},
    {"equalsTo", &ShieldnetDefendDBQueryBuilder::equalsTo},
    {"whereColumn", &ShieldnetDefendDBQueryBuilder::whereColumn},
    {"andColumn", &ShieldnetDefendDBQueryBuilder::andColumn},
    {"orColumn", &ShieldnetDefendDBQueryBuilder::orColumn},
    {"globalGetCommand", &ShieldnetDefendDBQueryBuilder::globalGetCommand},
    {"globalFindCommand", &ShieldnetDefendDBQueryBuilder::globalFindCommand},
    {"globalSelectCommand", &ShieldnetDefendDBQueryBuilder::globalSelectCommand},
    {"agentGetOsInfoCommand", &ShieldnetDefendDBQueryBuilder::agentGetOsInfoCommand},
    {"agentGetHotfixesCommand", &ShieldnetDefendDBQueryBuilder::agentGetHotfixesCommand},
    {"agentGetPackagesCommand", &ShieldnetDefendDBQueryBuilder::agentGetPackagesCommand}};

int main(const int argc, const char* argv[])
{
    try
    {
        CmdLineArgs cmdLineArgs(argc, argv);

        // Read json configuration file
        auto configuration = nlohmann::json::parse(std::ifstream(cmdLineArgs.getConfigurationFilePath()));
        nlohmann::json response;
        SocketDBWrapper::instance().init(SHIELDNET_DEFEND_DB_SOCK);

        for (const auto& query : configuration.at("queries"))
        {
            auto shieldnetdefendDBQueryBuilder = ShieldnetDefendDBQueryBuilder::builder();

            for (const auto& element : query)
            {
                if (!element.contains("arg"))
                {
                    (shieldnetdefendDBQueryBuilder.*(FUNC_MAP.at(element.at("method"))))();
                }
                else
                {
                    (shieldnetdefendDBQueryBuilder.*(FUNC_ARG_MAP.at(element.at("method"))))(element.at("arg"));
                }
            }

            auto queryStr = shieldnetdefendDBQueryBuilder.build();
            SocketDBWrapper::instance().query(queryStr, response);

            std::cout << "Response to \"" << queryStr << "\":\n" << response.dump(4) << std::endl;
        }
    }
    catch (const std::exception& e)
    {
        std::cerr << e.what() << std::endl;
        CmdLineArgs::showHelp();
        return 1;
    }
    return 0;
}
